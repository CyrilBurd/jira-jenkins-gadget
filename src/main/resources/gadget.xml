<?xml version="1.0" encoding="UTF-8" ?>
<Module>
    <ModulePrefs
-            title="Build Status"
-            author="Vlastimil Eliֳ¡ֵ¡"
-            author_email="velias@redhat.com"
-            description="This gadget allows to show status of defined build from Jenkins/Hudson server."
-            screenshot="__ATLASSIAN_BASE_URL__/download/resources/org.jboss.jira.plugin.build-gadgets/thumbnails/screenshot.png"
-            thumbnail="__ATLASSIAN_BASE_URL__/download/resources/org.jboss.jira.plugin.build-gadgets/thumbnails/thumbnail.png">
-        
    <Require feature="views" />
    <Require feature="dynamic-height" />
    <Require feature="settitle" />
    <Require feature="setprefs" />
    <Optional feature="atlassian.util" />
    <Optional feature="auth-refresh" />
    <Require feature="oauthpopup" />
    #supportedLocales("gadget.common,gadget.user.activity")
    #oauth
    <Optional feature="gadget-directory">
        <Param name="categories">Other</Param>
    </Optional>
    </ModulePrefs>
    <UserPref name="JenkinsJobName" display_name="Jenkins/Hudson Job name" datatype="string" required="true" default_value="JobName"/>
    <UserPref name="JenkinsURL" display_name="Jenkins/Hudson server URL" datatype="string" default_value="Jenkins Server Name" />
    <UserPref name="last_job_details" display_name="Load last build details" datatype="bool" default_value="true"/>
    <UserPref name="last_job_details_changeset" display_name="Show last build details changeset" datatype="bool" default_value="true" />
    <UserPref name="refreshinterval" display_name="Refresh interval" datatype="enum" default_value="" />
    <UserPref name="isConfigured" datatype="hidden" default_value="false" />
    <UserPref name="refresh" datatype="hidden" default_value="true" />

    <Content type="html" view="profile,canvas,home">
    <![CDATA[
    #requireResource("com.atlassian.jira.gadgets:common")
    #requireResource("com.atlassian.gadgets.publisher:ajs-gadgets")
    #requireResource("com.idberlin.jira.plugin.id-plugin:id-plugin-resources")
    #requireResource("com.atlassian.plugins.psp.jira-jenkins-gadget:jira-jenkins-gadget-resources")
    #includeResources()

     <div id='wrapper' style="display: block">
            <div id='jobtitle' style="display: none" width='100%' align='center'></div>
            <div id='jobdetails' style="display: none" width='100%'></div>
            <div id='lastjobdetails' style="display: none" width='100%'></div>
            <div id='gupdated' style="display: none" width='100%'></div>
     </div>

<script type="text/javascript">
    var prefs = new gadgets.Prefs();
    var gadget = AJS.Gadget({
    baseUrl: "__ATLASSIAN_BASE_URL__",
    useOauth: "/rest/gadget/1.0/currentUser",
    config: {
        descriptor: function(args){
        var gadget = this;

    function hideSections() {
      var sections = [ 'wrapper', 'jobtitle', 'jobdetails', 'lastjobdetails', 'gupdated' ];
      for (var i=0; i < sections.length; ++i) {
        var s = sections[i];
        var el = document.getElementById(s);
        el.style.display = "none";
      }
    };

        hideSections();
            return {
                action: "/rest/gadget/1.0/currentUser",
                theme: function ()
                            {
                                if (gadgets.window.getViewportDimensions().width < 450){
                                        return "gdt top-label";
                                    }
                                    else
                                    {
                                        return "gdt";
                                    }
                            }(),
                fields:[
                    {
						userpref: "JenkinsURL",
						label: "Jenkins URL: ",
						description: "Jenkins URL",
						type: "text",
						value: gadget.getPref("JenkinsURL")
				   },
                   {
						userpref: "JenkinsJobName",
						label: "Jenkins Job Name: ",
						description: "Job name",
						type: "text",
						value: gadget.getPref("JenkinsJobName")
				   },
				   {
				        userpref: "last_job_details",
                        label: "Show last job details",
                        description:"&nbsp  ",
                        type: "checkbox",
                        options:[{
                                    label: "",
                                    selected : prefs.getBool("last_job_details"),
                                }]
                   },
                   {
                        userpref: "last_job_details_changeset",
                        label: "Show last job changeset",
                        description:"&nbsp  ",
                        type: "checkbox",
                        options:[{
                                    label: "",
                                    selected:  prefs.getBool("last_job_details_changeset"),
                                }]
                   },
                   AJS.gadget.fields.nowConfigured()

                ]
            };
        },
    },
    view: {

        enableReload: true,
        onResizeReload: true,

        template: function (args) {

        var gadget = this;
        var jobname = gadget.getPref("JenkinsJobName");
        gadget.getView().empty();

        if (jobname && jobname.length > 0 ){
            gadgets.window.setTitle("Build Status - " + gadget.getPref("JenkinsJobName"));
            var color;
            showSections();
            makeJSONRequest(jenkinsJobURL(gadget),responseMain);

        };

    function showSections() {
      var sections = [ 'wrapper', 'jobtitle', 'jobdetails', 'lastjobdetails', 'gupdated' ];
      for (var i=0; i < sections.length; ++i) {
        var s = sections[i];
        var el = document.getElementById(s);
        el.style.display = "block";
       }
    };



}

    }
});

</script>

 ]]>
    </Content>
 </Module>
